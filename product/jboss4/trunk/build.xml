<?xml version="1.0" encoding="utf-8"?>

<!--
Title: build.xml
Description: Build for ESSA JBoss4.  Uses XDoclet.
Development Environment: Java 1.5.0_06, Apache Ant 1.6.5, JBoss 4.0.5.GA, XDoclet 1.3 SNAPSHOT
Author: G.S. Cole (guycole at gmail dot com)
-->

<project name="jboss4" default="jar" basedir=".">
  <property file="../../ant.properties"/>

  <property name="Name" value="jboss4"/>
  <property name="version" value="0.1"/>

  <property name="client.jar" value="${product.jboss.client.jar}"/>
  <property name="server.jar" value="${product.jboss.server.jar}"/>

  <property name="client.filter" value="com/bgi/essa/jboss4/client/**"/>
  <property name="jmx.filter" value="com/bgi/essa/jboss4/jmx/**"/>
  <property name="junit.filter" value="com/bgi/essa/jboss4/junit/**"/>
  <property name="pruner.filter" value="com/bgi/essa/jboss4/varia/**"/>
  <property name="test.filter" value="com/bgi/essa/jboss4/test/**"/>

  <property name="jboss.server.deploy.dir" value="${jboss.home.dir}/server/${jboss.configuration}/deploy"/>
  <property name="jboss.server.lib.dir" value="${jboss.home.dir}/server/${jboss.configuration}/lib"/>
  <property name="quartz.dir" value="${jboss.server.deploy.dir}/quartz-service.sar"/>

  <property name="project.dir" value="${product.jboss.dir}"/>

  <property name="build.dir" value="${project.dir}/build"/>
  <property name="build.classes.dir" value="${build.dir}/classes"/>
  <property name="build.deploy.dir" value="${build.dir}/deploy"/>
  <property name="build.meta.dir" value="${build.dir}/META-INF"/>

  <property name="cc.dir" value="${project.dir}/cc/${os.name}"/>

  <property name="etc.dir" value="${project.dir}/etc"/>

  <property name="javadoc.dir" value="${project.dir}/javadoc"/>

  <property name="junit.dir" value="${project.dir}/junit"/>

  <property name="lib.dir" value="${project.dir}/lib"/>
  
  <property name="src.dir" value="${project.dir}/src"/>

  <property name="src.gen.dir" value="${build.dir}/src"/>

  <property name="quartz.jar" value="${quartz.dir}/lib/quartz-1.6.0.jar"/>

  <path id="javac.path">
    <pathelement location="${jbossall_client.jar}"/>
    <pathelement location="${jboss_logging.jar}"/>
    <pathelement location="${jboss.server.lib.dir}/jboss-hibernate.jar"/>
    <pathelement location="${jboss.server.lib.dir}/hibernate3.jar"/>
    <pathelement location="${jboss.server.lib.dir}/scheduler-plugin.jar"/>
    <pathelement location="${jboss_system.jar}"/>

    <pathelement location="${commons_chain.jar}"/>
    <pathelement location="${commons_digester.jar}"/>

    <pathelement location="${junit.jar}"/>
    <pathelement location="${quartz.jar}"/>

    <pathelement location="${strutsunit.jar}"/>
    <pathelement location="${product.blessed.dir}/${product.shared.jar}"/>
  </path>
 
  <path id="javah.path">
    <pathelement location="${build.classes.dir}"/>
    <pathelement location="${product.blessed.dir}/${product.shared.jar}"/>
  </path>

  <path id="junit.path">
    <pathelement location="${etc.dir}"/>

    <pathelement location="${junit.jar}"/>
    <pathelement location="${strutsunit.jar}"/>

    <pathelement location="${commons_chain.jar}"/>

    <pathelement location="${jbossall_client.jar}"/>
    <pathelement location="${jboss_logging.jar}"/>

    <pathelement location="${build.classes.dir}"/>
    <pathelement location="${product.blessed.dir}/${product.shared.jar}"/>
  </path>

  <path id="xdoclet.path">
    <pathelement location="${jbossall_client.jar}"/>

    <fileset dir="${xdoclet.home.dir}/lib">
      <include name="*.jar"/>
    </fileset>
  </path>

  <!-- =================================================================== -->
  <!-- Initialization                                                      -->
  <!-- =================================================================== -->
  <target name="init" description="Initialization">
    <tstamp/>
  </target>

  <!-- =================================================================== -->
  <!-- Environment Report                                                  -->
  <!-- =================================================================== -->
  <target name="env-report" depends="init" description="Environment Report">
    <echo message="base.dir = ${base.dir}"/>
    <echo message="project.dir = ${project.dir}"/>
    <echo message="build.dir = ${build.dir}"/>
    <echo message="jboss.home.dir = ${jboss.home.dir}"/>
  </target>

  <!-- =================================================================== -->
  <!-- Remove The Current Build                                            -->
  <!-- =================================================================== -->
  <target name="clean" depends="init" description="Delete Generated Items">
    <delete dir="${build.dir}"/>
    <delete dir="${javadoc.dir}"/>
    <delete dir="${junit.dir}"/>
  </target>

  <!-- =================================================================== -->
  <!-- Invoke EjbDoclet (part of XDoclet)                                  -->
  <!--   Must run before javac to generate sources                         -->
  <!--   EJB must be named *Bean.java                                      -->
  <!-- =================================================================== -->
  <target name="ejbdoc" depends="init" description="Run EjbDoclet">
    <taskdef name="ejbdoclet" classname="xdoclet.modules.ejb.EjbDocletTask" classpathref="xdoclet.path"/>

   <tstamp>
      <format property="TODAY" pattern="yyyy-MM-dd"/>
    </tstamp>

    <ejbdoclet destdir="${src.gen.dir}" excludedtags="@version,@author" addedtags="@xdoclet-generated at ${TODAY}" ejbspec="${xdoclet.ejb.version}" force="${xdoclet.force}" verbose="${xdoclet.verbose}">
      <packageSubstitution packages="entrance" substituteWith="client"/>

      <fileset dir="${src.dir}">
        <include name="**/*Bean.java"/>
      </fileset>

      <remoteinterface pattern="{0}Remote"/>
      <localinterface pattern="{0}Local"/>

      <homeinterface pattern="{0}HomeRemote"/>
      <localhomeinterface pattern="{0}LocalHome"/>

      <entitypk/>
      <entitycmp/>

      <session/>

      <mdb/>

      <utilobject kind="physical" cacheHomes="true" includeGUID="true">
        <packageSubstitution packages="entrance" substituteWith="client"/>
      </utilobject>

      <deploymentdescriptor destdir="${build.meta.dir}"/>

      <jboss version="${xdoclet.jboss.version}" validateXml="false" xmlencoding="UTF-8" destdir="${build.meta.dir}"/>
    </ejbdoclet>
  </target>

  <!-- =================================================================== -->
  <!-- Compile Application                                                 -->
  <!-- =================================================================== -->
  <target name="compile" depends="ejbdoc" description="Compile Application">
    <mkdir dir="${build.classes.dir}"/>
 
    <javac destdir="${build.classes.dir}" verbose="${javac.verbose}" debug="${javac.debug}" deprecation="${javac.depreciation}" optimize="${javac.optimize}" classpathref="javac.path">
      <src path="${src.gen.dir}"/>
      <src path="${src.dir}"/>
    </javac>
  </target>

  <!-- =================================================================== -->
  <!-- Generate JNI Stubs                                                  -->
  <!-- =================================================================== -->
  <target name="jni" depends="compile" description="Generate JNI Stubs">
    <javah outputFile="${cc.dir}/jni_stub.h" classpathref="javah.path">
      <class name="com.bgi.essa.jboss4.jmx.JniStub"/>
    </javah>

    <exec dir="${cc.dir}" executable="make">
      <arg line="clean"/>
    </exec>

    <exec dir="${cc.dir}" executable="make"/>
  </target>

  <!-- =================================================================== -->
  <!-- Generate JNI Stubs                                                  -->
  <!-- =================================================================== -->
  <target name="jni-deploy" depends="jni" description="Deploy JNI">
    <copy file="${cc.dir}/libEssaStub.so" todir="${base.jre.lib}"/>
  </target>

  <!-- =================================================================== -->
  <!-- Package (jar) Application                                           -->
  <!-- =================================================================== -->
  <target name="jar" depends="compile" description="Package Application">
    <mkdir dir="${build.deploy.dir}"/>

    <tstamp>
      <format property="TIME_NOW" pattern="yyyy-MM-dd HH:mm"/>
    </tstamp>

    <!-- server classes, deployed to JBoss -->
    <jar jarfile="${build.deploy.dir}/${server.jar}" index="true">
      <manifest>
        <attribute name="Built-By" value="${user.name}"/>
        <attribute name="Build-On" value="${TIME_NOW}"/>
      </manifest>

      <fileset dir="${build.classes.dir}"/>

      <metainf dir="${build.meta.dir}">
        <include name="ejb-jar.xml"/>
        <include name="jboss.xml"/>
      </metainf>
    </jar>

    <!-- clients get interfaces and utilities only -->
    <jar jarfile="${build.deploy.dir}/${client.jar}" index="true">
      <manifest>
        <attribute name="Built-By" value="${user.name}"/>
        <attribute name="Build-On" value="${TIME_NOW}"/>
      </manifest>

      <fileset dir="${build.classes.dir}" includes="${client.filter}"/>
      <fileset dir="${build.classes.dir}" includes="${test.filter}"/>
    </jar>

    <!-- sar gets jmx only -->
    <jar jarfile="${build.deploy.dir}/${product.instrument.sar}" index="true">
      <manifest>
        <attribute name="Built-By" value="${user.name}"/>
        <attribute name="Build-On" value="${TIME_NOW}"/>
      </manifest>

      <fileset dir="${build.classes.dir}" includes="${jmx.filter}"/>

      <metainf dir="${etc.dir}/jmx.sar">
        <include name="jboss-service.xml"/>
      </metainf>
    </jar>
  	
  	<!-- sar gets pruner only -->
    <jar jarfile="${build.deploy.dir}/${product.pruner.sar}" index="true">
      <manifest>
        <attribute name="Built-By" value="${user.name}"/>
        <attribute name="Build-On" value="${TIME_NOW}"/>
      </manifest>

      <fileset dir="${build.classes.dir}" includes="${pruner.filter}"/>
      <fileset file="${commons_chain.jar}"/>
   	  <fileset file="${build.deploy.dir}/${client.jar}"/>
      <fileset file="${product.blessed.dir}/${product.shared.jar}"/>
    	
      <metainf dir="${etc.dir}/pruner.sar">
        <include name="jboss-service.xml"/>
      </metainf>
    </jar>
  </target>

  <!-- =================================================================== -->
  <!-- Copy jars to share w/other tiers                                    -->
  <!-- =================================================================== -->
  <target name="blessed" depends="jar" description="Copy JAR To Lib Directory">
    <copy file="${build.deploy.dir}/${server.jar}" todir="${product.blessed.dir}"/>
    <copy file="${build.deploy.dir}/${client.jar}" todir="${product.blessed.dir}"/>
    <copy file="${build.deploy.dir}/${product.instrument.sar}" todir="${product.blessed.dir}"/>
    <copy file="${build.deploy.dir}/${product.pruner.sar}" todir="${product.blessed.dir}"/>
  </target>

  <!-- =================================================================== -->
  <!-- JUnit Tests                                                         -->
  <!-- =================================================================== -->
  <target name="junit" depends="blessed" description="Unit Tests">
    <delete dir="${junit.dir}"/>
    <mkdir dir="${junit.dir}"/>

    <junit printsummary="yes" haltonfailure="yes" fork="yes">
      <classpath refid="junit.path"/>
      <formatter type="plain"/>
      <batchtest fork="yes" todir="${junit.dir}">
        <fileset dir="${src.dir}">
          <include name="${junit.filter}"/>
        </fileset>
      </batchtest>
    </junit>
  </target>

  <!-- =================================================================== -->
  <!-- JavaDoc                                                             -->
  <!-- =================================================================== -->
  <target name="javadoc" depends="init" description="Create JavaDoc">
    <delete dir="${javadoc.dir}"/>
    <mkdir dir="${javadoc.dir}"/>

    <javadoc sourcepath="${src.dir}:${src.gen.dir}"
      destdir="${javadoc.dir}"
      classpath="${commons_chain.jar}:${product.blessed.dir}/${product.shared.jar}:${jbossall_client.jar}:${jboss_logging.jar}:${jboss.server.lib.dir}/hibernate3.jar"
      packagenames="*"
      author="true"
      version="true"
      private="true"
      windowtitle="ESM ESSA API Documentation"
      doctitle="&lt;h1&gt;ESM ESSA Documentation&lt;/h1&gt;">

      <tag dir="${etc.dir}" includes="javadoc.tags"/>
    </javadoc>
  </target>
</project>
